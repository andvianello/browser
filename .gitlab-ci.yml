variables:
  CONTAINER_IMAGE: "gitlab.inf.unibz.it:4567/lter/browser"
  DOCKER_TESTER_IMAGE: "golang:1.13.5"
  DOCKER_BUILDER_IMAGE: "docker:19.03.1"
  DOCKER_TLS_CERTDIR: "" # See https://gitlab.com/gitlab-org/gitlab-runner/issues/4501
  KUBECTL: "https://storage.googleapis.com/kubernetes-release/release/v1.8.10/bin/linux/amd64/kubectl"

stages:
  - testing
  - build
  - tag
  - deploy

testing:
  stage: testing
  image: ${DOCKER_TESTER_IMAGE}
  script:
    - cd ${CI_PROJECT_DIR}
    - go test gitlab.inf.unibz.it/lter/browser/...
  only:
    - master

build:
  stage: build
  image: ${DOCKER_BUILDER_IMAGE}
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN https://gitlab.inf.unibz.it:4567
  script:
    - docker  build --rm --no-cache --tag=${CONTAINER_IMAGE}:${CI_COMMIT_SHA} .
    - docker push ${CONTAINER_IMAGE}:${CI_COMMIT_SHA}
  only:
   - master

tag_image:
  stage: tag
  image: ${DOCKER_BUILDER_IMAGE}
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN gitlab.inf.unibz.it:4567
  script:
    - docker pull ${CONTAINER_IMAGE}:${CI_COMMIT_SHA}
    - docker tag ${CONTAINER_IMAGE}:${CI_COMMIT_SHA} ${CONTAINER_IMAGE}:${CI_COMMIT_TAG}
    - docker push ${CONTAINER_IMAGE}:${CI_COMMIT_TAG}
  only:
    - tags

deploy_staging:
  stage: deploy
  image: ${DOCKER_BUILDER_IMAGE}
  services:
    - docker:dind
  before_script:
    - wget ${KUBECTL}
    - mv kubectl /usr/bin/
    - chmod +x /usr/bin/kubectl
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN gitlab.inf.unibz.it:4567
  script:
    - docker pull ${CONTAINER_IMAGE}:${CI_COMMIT_SHA}
    - kubectl --namespace eurac-alpenv-browser-stage set image deployment/browser browser=${CONTAINER_IMAGE}:${CI_COMMIT_SHA}
  environment:
    name: staging
  only:
    - master

#deploy_production:
#  stage: deploy
#  image: ${DOCKER_BUILDER_IMAGE}
#  services:
#    - docker:dind
#  before_script:
#    - wget ${KUBECTL}
#    - mv kubectl /usr/bin/
#    - chmod +x /usr/bin/kubectl
#    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN gitlab.inf.unibz.it:4567
#  script:
#    - docker pull ${CONTAINER_IMAGE}:${CI_COMMIT_SHA}
#    - docker tag ${CONTAINER_IMAGE}:${CI_COMMIT_SHA} ${CONTAINER_IMAGE}:${CI_COMMIT_TAG}
#    - docker push ${CONTAINER_IMAGE}:${CI_COMMIT_TAG}
#    - kubectl --namespace eurac-alpenv-browser set image deployment/browser browser=${CONTAINER_IMAGE}:${CI_COMMIT_TAG}
#  environment:
#    name: production
#  when: manual
#  only:
#    - tags
#  only:
#    - master
