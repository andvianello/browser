// Copyright 2019 Eurac Research. All rights reserved.

// browser sets up the client for filtering and downloading LTER data.
// opts is an object with these keys data - JSON data object
//	stationEl - stations select element
//	measurementEl - measurements select element
//	landuseEl - landuse select element
//	altitudeEl - altitude range element
//	dateEl - date picker element
//	sDateEl - start date element
//	eDateEl - end date element
//	submitEl - submit button element
//	codeEl - code button element
//	dlMapAreaEl - area for download links on the map
//	mapEl - map element
function browser(opts) {
	const mapMarkers = {};

	function getMaxAltitude() {
		let a = 0;

		opts.data.forEach(function(s) {
			if (s.Altitude >= a) {
				a = s.Altitude
			}
		});

		return Math.round(a/1000)*1000;
	}

	function getMinAltitude() {
		let a = 10000;

		opts.data.forEach(function(s) {
			if (s.Altitude <= a) {
				a = s.Altitude
			}
		});

		return Math.floor(a/100)*100;
	}

	function loadMap() {
		const map = L.map(opts.mapEl, {zoomControl: false}).setView([46.69765764825818, 10.638368502259254], 13);

		const basemap = {
		"Orthophotos South Tyrol (2014/2015/2017)": L.tileLayer.wms('http://geoservices.retecivica.bz.it/geoserver/ows?', {
			layers: 'P_BZ_OF_2014_2015_2017',
			attribution: 'Map data &copy; <a href="http://geoportal.buergernetz.bz.it/geodaten.asp">Geoportal SÃ¼dtirol</a>, <a href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">CC-0</a>'
		}).addTo(map),

		"Open Street Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?', {
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}),

		"OpenTopoMap": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
		attribution: 'Kartendaten: &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>-Mitwirkende, SRTM | Kartendarstellung: &copy; <a href="http://opentopomap.org/">OpenTopoMap<a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),

		"Google Maps Terrain": L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
			maxZoom: 20,
			subdomains:['mt0','mt1','mt2','mt3'],
			attribution: 'Map data &copy; Google.'})
		}

		const points = [{"lat":46.800205602492,"lon":10.719589790561},{"lat":46.800288943091,"lon":10.719773394119},{"lat":46.800349332259,"lon":10.719906437844},{"lat":46.800011366853,"lon":10.719939073942},{"lat":46.799680227144,"lon":10.720117363714},{"lat":46.799639383639,"lon":10.720139354441},{"lat":46.799492891028,"lon":10.720305865444},{"lat":46.799331773105,"lon":10.720547265313},{"lat":46.799250804818,"lon":10.720718511314},{"lat":46.799178406207,"lon":10.720871633464},{"lat":46.799113274027,"lon":10.721013709036},{"lat":46.798994531134,"lon":10.721429274363},{"lat":46.798639777181,"lon":10.722587809073},{"lat":46.79845978268,"lon":10.723175606281},{"lat":46.798302141599,"lon":10.723783212276},{"lat":46.79823049782,"lon":10.724058578576},{"lat":46.798049118338,"lon":10.724748141543},{"lat":46.797857962003,"lon":10.72548898783},{"lat":46.797714295266,"lon":10.726064266232},{"lat":46.797484021384,"lon":10.726116691043},{"lat":46.797123999311,"lon":10.726119917383},{"lat":46.796926430504,"lon":10.726092303363},{"lat":46.796905623631,"lon":10.726100297489},{"lat":46.796700135449,"lon":10.726179250013},{"lat":46.796469577463,"lon":10.726250500008},{"lat":46.795835987775,"lon":10.726491495336},{"lat":46.795572551282,"lon":10.72665423603},{"lat":46.79518191212,"lon":10.72689726257},{"lat":46.794991213405,"lon":10.727010732551},{"lat":46.794777137435,"lon":10.727182420462},{"lat":46.794631302174,"lon":10.727304696958},{"lat":46.794256871895,"lon":10.727666166167},{"lat":46.793777242593,"lon":10.728140555701},{"lat":46.793638373589,"lon":10.728397357859},{"lat":46.793300492678,"lon":10.728424209476},{"lat":46.793065930479,"lon":10.728462559239},{"lat":46.79261443737,"lon":10.728563573712},{"lat":46.792381148835,"lon":10.728517610043},{"lat":46.791940765224,"lon":10.728478938225},{"lat":46.791154754361,"lon":10.728384159502},{"lat":46.790711575197,"lon":10.728339752738},{"lat":46.790566188119,"lon":10.72832518392},{"lat":46.790322890494,"lon":10.728346057147},{"lat":46.790155432147,"lon":10.728410301146},{"lat":46.789996090812,"lon":10.728532949006},{"lat":46.789746267633,"lon":10.728687913046},{"lat":46.789545941503,"lon":10.728842820012},{"lat":46.788957712047,"lon":10.729357082719},{"lat":46.78842794786,"lon":10.729873204824},{"lat":46.788084262048,"lon":10.730283917027},{"lat":46.787878582193,"lon":10.730495146137},{"lat":46.787561653098,"lon":10.730624194906},{"lat":46.78733046103,"lon":10.730737155462},{"lat":46.786895829166,"lon":10.730913197235},{"lat":46.786647538321,"lon":10.730966652173},{"lat":46.786299101481,"lon":10.731096322788},{"lat":46.785756752126,"lon":10.731254164824},{"lat":46.785382494141,"lon":10.731306032382},{"lat":46.785121441315,"lon":10.73131076191},{"lat":46.784941491992,"lon":10.731308266361},{"lat":46.784771305458,"lon":10.731255316328},{"lat":46.784650467504,"lon":10.731212137417},{"lat":46.784503771416,"lon":10.731093614561},{"lat":46.784293218707,"lon":10.731032003558},{"lat":46.78403692337,"lon":10.731019690165},{"lat":46.783861459085,"lon":10.731018159961},{"lat":46.783537069778,"lon":10.731045424636},{"lat":46.783203400693,"lon":10.731091222497},{"lat":46.782796533302,"lon":10.731216556262},{"lat":46.782624551108,"lon":10.731282275602},{"lat":46.782466866287,"lon":10.73129523279},{"lat":46.782043370926,"lon":10.731329963236},{"lat":46.781829819091,"lon":10.73116918332},{"lat":46.781484585761,"lon":10.730789661999},{"lat":46.781117729962,"lon":10.730352138255},{"lat":46.780779699609,"lon":10.730388794117},{"lat":46.780482295258,"lon":10.730416926358},{"lat":46.780218007112,"lon":10.730338042907},{"lat":46.779791239564,"lon":10.730291616548},{"lat":46.779553589779,"lon":10.730236513479},{"lat":46.779070755234,"lon":10.730029455459},{"lat":46.778516430313,"lon":10.729788999078},{"lat":46.778292990242,"lon":10.729686868292},{"lat":46.777808410313,"lon":10.729595203305},{"lat":46.777666091139,"lon":10.729632899545},{"lat":46.777596075039,"lon":10.729651445618},{"lat":46.777474869586,"lon":10.729783130542},{"lat":46.777431381328,"lon":10.729830381029},{"lat":46.777262842733,"lon":10.730001555878},{"lat":46.777256541875,"lon":10.730007955735},{"lat":46.777221167828,"lon":10.730043883837},{"lat":46.777059964427,"lon":10.730193924245},{"lat":46.776860618158,"lon":10.730379466901},{"lat":46.776445330047,"lon":10.730764051018},{"lat":46.776371194611,"lon":10.730839392794},{"lat":46.77607516429,"lon":10.731140251372},{"lat":46.775736343654,"lon":10.731526455707},{"lat":46.775343675567,"lon":10.731902744686},{"lat":46.775173935898,"lon":10.732117526347},{"lat":46.774826662216,"lon":10.732467428313},{"lat":46.774505938771,"lon":10.732846829807},{"lat":46.774341736013,"lon":10.732993014301},{"lat":46.774050699874,"lon":10.73289771668},{"lat":46.773854024403,"lon":10.732811176724},{"lat":46.773636100522,"lon":10.732642089368},{"lat":46.773476668659,"lon":10.732473242393},{"lat":46.773318624055,"lon":10.732212751166},{"lat":46.773250925245,"lon":10.731928961662},{"lat":46.772971308183,"lon":10.731376409246},{"lat":46.772675422974,"lon":10.731006718595},{"lat":46.7724127935,"lon":10.730818199513},{"lat":46.772048292849,"lon":10.730522449323},{"lat":46.771789256613,"lon":10.73039381197},{"lat":46.77143850707,"lon":10.730081319028},{"lat":46.77126233065,"lon":10.729829267433},{"lat":46.771085275408,"lon":10.729635313309},{"lat":46.770910701239,"lon":10.7295748769},{"lat":46.770493088363,"lon":10.729518116219},{"lat":46.770148202347,"lon":10.729412934469},{"lat":46.769938154993,"lon":10.729317799698},{"lat":46.769701125866,"lon":10.728923830183},{"lat":46.769224760443,"lon":10.72888402493},{"lat":46.768982957988,"lon":10.728805886674},{"lat":46.768590094289,"lon":10.728600126678},{"lat":46.768192102298,"lon":10.728435951691},{"lat":46.767910069004,"lon":10.728340158329},{"lat":46.767636907046,"lon":10.728252835557},{"lat":46.767412723341,"lon":10.728199823351},{"lat":46.767227509521,"lon":10.728247923359},{"lat":46.767182386223,"lon":10.728258655101},{"lat":46.767033325366,"lon":10.728294098937},{"lat":46.766821015149,"lon":10.728348700035},{"lat":46.766787848825,"lon":10.728376792891},{"lat":46.766666873956,"lon":10.728479261296},{"lat":46.766647810606,"lon":10.728495410179},{"lat":46.766429717281,"lon":10.728634951515},{"lat":46.766210276243,"lon":10.728863672245},{"lat":46.766069307838,"lon":10.72896148101},{"lat":46.765801845371,"lon":10.729139797758},{"lat":46.7657283962,"lon":10.729188764857},{"lat":46.76539324297,"lon":10.729332742525},{"lat":46.765115526113,"lon":10.729844440344},{"lat":46.764801319636,"lon":10.730388522322},{"lat":46.76469047137,"lon":10.730577327501},{"lat":46.76436737786,"lon":10.731113751143},{"lat":46.763997560848,"lon":10.731764080169},{"lat":46.763706724833,"lon":10.732249959556},{"lat":46.763480139969,"lon":10.732355648912},{"lat":46.762977906208,"lon":10.732538439502},{"lat":46.762791823444,"lon":10.732643788183},{"lat":46.762312807781,"lon":10.732779029188},{"lat":46.761476927424,"lon":10.733005950603},{"lat":46.761013521889,"lon":10.733298832787},{"lat":46.760641119389,"lon":10.733525061789},{"lat":46.760512531681,"lon":10.733578809895},{"lat":46.760410172253,"lon":10.733621595515},{"lat":46.759924513199,"lon":10.733898203737},{"lat":46.759562617286,"lon":10.734024907346},{"lat":46.759345546611,"lon":10.734096512223},{"lat":46.75897791638,"lon":10.734007780778},{"lat":46.758633033911,"lon":10.733902594991},{"lat":46.758234801059,"lon":10.733754774143},{"lat":46.75803423526,"lon":10.733628031931},{"lat":46.757761225767,"lon":10.733530883615},{"lat":46.757694530615,"lon":10.733518449028},{"lat":46.757527900548,"lon":10.733487388141},{"lat":46.757333962216,"lon":10.733517177154},{"lat":46.756773345605,"lon":10.73369233749},{"lat":46.756208132036,"lon":10.73387389406},{"lat":46.755827340933,"lon":10.734059727869},{"lat":46.75558441336,"lon":10.734056023302},{"lat":46.755575867957,"lon":10.734054300937},{"lat":46.755135815144,"lon":10.733965521158},{"lat":46.754629440703,"lon":10.734124406622},{"lat":46.754131056729,"lon":10.734349831848},{"lat":46.753831877291,"lon":10.734494903184},{"lat":46.753424224146,"lon":10.734671679178},{"lat":46.753166799406,"lon":10.73473379524},{"lat":46.752759021865,"lon":10.734918746878},{"lat":46.752478737311,"lon":10.73500467755},{"lat":46.752077962608,"lon":10.735024545748},{"lat":46.751826714328,"lon":10.735049533392},{"lat":46.751636325763,"lon":10.735068468647},{"lat":46.75136241164,"lon":10.735031035829},{"lat":46.751144968101,"lon":10.735127164448},{"lat":46.750994999595,"lon":10.735224638599},{"lat":46.75077253733,"lon":10.735354974012},{"lat":46.750672190104,"lon":10.73544422352},{"lat":46.750561520181,"lon":10.735620699222},{"lat":46.750467908445,"lon":10.735719514847},{"lat":46.750095079969,"lon":10.736113071874},{"lat":46.749977888206,"lon":10.736422716964},{"lat":46.749872822318,"lon":10.736822766892},{"lat":46.749638579335,"lon":10.736839789221},{"lat":46.749624551566,"lon":10.736837743434},{"lat":46.749364703076,"lon":10.736799893827},{"lat":46.749190579055,"lon":10.736710013285},{"lat":46.748995233639,"lon":10.736535989165},{"lat":46.748822487233,"lon":10.736355326074},{"lat":46.748632507597,"lon":10.736124193692},{"lat":46.748451671358,"lon":10.735883540395},{"lat":46.748274798583,"lon":10.735678200393},{"lat":46.747874805291,"lon":10.735646535236},{"lat":46.747586281959,"lon":10.735682277763},{"lat":46.74741490493,"lon":10.73570786926},{"lat":46.746943000987,"lon":10.735670622659},{"lat":46.746740637654,"lon":10.735662488814},{"lat":46.746498503874,"lon":10.73560643938},{"lat":46.746356010199,"lon":10.735507764179},{"lat":46.74596917981,"lon":10.735201597538},{"lat":46.745520586253,"lon":10.734814082669},{"lat":46.745302960815,"lon":10.734625451152},{"lat":46.745118587369,"lon":10.734617898866},{"lat":46.744944721676,"lon":10.734510859905},{"lat":46.744703727856,"lon":10.734379574406},{"lat":46.744466847044,"lon":10.734273788509},{"lat":46.744251077648,"lon":10.734259504561},{"lat":46.744092437144,"lon":10.734335417425},{"lat":46.743728792065,"lon":10.734577397148},{"lat":46.743433750145,"lon":10.734746300075},{"lat":46.743125227805,"lon":10.734913952026},{"lat":46.742957083332,"lon":10.735023104237},{"lat":46.742757567779,"lon":10.73512388364},{"lat":46.742373281707,"lon":10.735243281167},{"lat":46.74219600547,"lon":10.735361136266},{"lat":46.742002004308,"lon":10.735395002186},{"lat":46.741775987107,"lon":10.735463020429},{"lat":46.741344088844,"lon":10.735458155933},{"lat":46.741028456131,"lon":10.735501207698},{"lat":46.740816824609,"lon":10.735510778187},{"lat":46.740504111875,"lon":10.735064659318},{"lat":46.740345512226,"lon":10.734841123184},{"lat":46.740131900381,"lon":10.734684545458},{"lat":46.739923554444,"lon":10.73447741565},{"lat":46.739613302197,"lon":10.734165565458},{"lat":46.739100351381,"lon":10.733570691198},{"lat":46.738732508208,"lon":10.733198919157},{"lat":46.738542707565,"lon":10.73299901271},{"lat":46.73849776883,"lon":10.732951681256},{"lat":46.738147306769,"lon":10.732620564349},{"lat":46.737916419689,"lon":10.732415997481},{"lat":46.737819268049,"lon":10.732314556357},{"lat":46.737584193673,"lon":10.732069109492},{"lat":46.737127087739,"lon":10.731648685791},{"lat":46.736953862249,"lon":10.731499151864},{"lat":46.736650604086,"lon":10.7313192765},{"lat":46.736396224544,"lon":10.73118023665},{"lat":46.736158498681,"lon":10.731130085539},{"lat":46.735900357487,"lon":10.731239627359},{"lat":46.735683436457,"lon":10.731301402523},{"lat":46.73545957443,"lon":10.731227152901},{"lat":46.735239714946,"lon":10.731185755309},{"lat":46.734700802674,"lon":10.731116147587},{"lat":46.734395675548,"lon":10.731059749214},{"lat":46.734207298692,"lon":10.731019360907},{"lat":46.733917885128,"lon":10.731113993129},{"lat":46.733457008366,"lon":10.731239946752},{"lat":46.733230980873,"lon":10.731308788758},{"lat":46.732815091593,"lon":10.731435363031},{"lat":46.732697314185,"lon":10.731487219549},{"lat":46.732463645469,"lon":10.731763597074},{"lat":46.732042805521,"lon":10.732230081858},{"lat":46.732042606077,"lon":10.732230303146},{"lat":46.731714190248,"lon":10.73252327196},{"lat":46.731531180782,"lon":10.732722735824},{"lat":46.731349273242,"lon":10.732849428035},{"lat":46.73113757204,"lon":10.732902684619},{"lat":46.731109876076,"lon":10.732909652346},{"lat":46.730901738627,"lon":10.73298560518},{"lat":46.730622098887,"lon":10.733028998428},{"lat":46.730198699085,"lon":10.733057149448},{"lat":46.729600688045,"lon":10.733027356987},{"lat":46.729303553526,"lon":10.733037468971},{"lat":46.72909115379,"lon":10.73309773903},{"lat":46.728913631932,"lon":10.7332319253},{"lat":46.728709731678,"lon":10.733325185867},{"lat":46.72860088537,"lon":10.73308448351},{"lat":46.728421177296,"lon":10.732471785853},{"lat":46.728146844305,"lon":10.731867514447},{"lat":46.727875149644,"lon":10.731386029189},{"lat":46.727679428624,"lon":10.730938882107},{"lat":46.727499061739,"lon":10.730666454298},{"lat":46.727322078749,"lon":10.730467753129},{"lat":46.727144848087,"lon":10.73028540454},{"lat":46.726972089928,"lon":10.730104836116},{"lat":46.726943538561,"lon":10.73007125427},{"lat":46.726804088646,"lon":10.729907242351},{"lat":46.726654600397,"lon":10.729425940464},{"lat":46.726649618171,"lon":10.729409895832},{"lat":46.726433279412,"lon":10.728837779104},{"lat":46.726269806985,"lon":10.728042419225},{"lat":46.726135960248,"lon":10.727370701648},{"lat":46.726051600576,"lon":10.726997478467},{"lat":46.725939643223,"lon":10.726365725892},{"lat":46.725763560875,"lon":10.725510270754},{"lat":46.725634430863,"lon":10.724823173824},{"lat":46.725585192893,"lon":10.724507516802},{"lat":46.725494194113,"lon":10.723977050233},{"lat":46.725450079558,"lon":10.723619841855},{"lat":46.725408823507,"lon":10.72337151176},{"lat":46.725039925008,"lon":10.72336630377},{"lat":46.724639050943,"lon":10.723392794194},{"lat":46.724395677538,"lon":10.723399335111},{"lat":46.724193398285,"lon":10.723404771248},{"lat":46.72381989129,"lon":10.72340677936},{"lat":46.723591953847,"lon":10.723531011187},{"lat":46.723434248562,"lon":10.723616964559},{"lat":46.723242493326,"lon":10.723800608422},{"lat":46.723037220485,"lon":10.723985456066},{"lat":46.722866313804,"lon":10.724278540044},{"lat":46.72264579765,"lon":10.724579039291},{"lat":46.722612073927,"lon":10.724630413967},{"lat":46.72249381641,"lon":10.72481056632},{"lat":46.722247903744,"lon":10.725004742876},{"lat":46.722083908332,"lon":10.72513773806},{"lat":46.721934145188,"lon":10.725222110272},{"lat":46.721776508721,"lon":10.72523180569},{"lat":46.721527503277,"lon":10.725332644782},{"lat":46.721305729735,"lon":10.725417990776},{"lat":46.72109396223,"lon":10.725436593256},{"lat":46.720882342717,"lon":10.725445382768},{"lat":46.72069422194,"lon":10.725387860144},{"lat":46.72044933417,"lon":10.725215660287},{"lat":46.720055636158,"lon":10.724827906184},{"lat":46.720023682106,"lon":10.724796434618},{"lat":46.719748185335,"lon":10.724565198533},{"lat":46.719627958419,"lon":10.724182705985},{"lat":46.71943433847,"lon":10.723594232739},{"lat":46.719344433788,"lon":10.723289584095},{"lat":46.719266986742,"lon":10.723054034877},{"lat":46.719155195909,"lon":10.722708618825},{"lat":46.718963450884,"lon":10.721995085372},{"lat":46.71881793968,"lon":10.721498119353},{"lat":46.718495041048,"lon":10.721127186274},{"lat":46.718305150197,"lon":10.720888064777},{"lat":46.71810603005,"lon":10.720664191732},{"lat":46.717951036909,"lon":10.720498154458},{"lat":46.717921838716,"lon":10.720473133997},{"lat":46.717702258282,"lon":10.720284971363},{"lat":46.717519738307,"lon":10.720154045245},{"lat":46.717132726159,"lon":10.719857146286},{"lat":46.716857329376,"lon":10.719618589528},{"lat":46.716639565092,"lon":10.719437479936},{"lat":46.716354545689,"lon":10.719240331042},{"lat":46.716118532515,"lon":10.719075817066},{"lat":46.71595804448,"lon":10.718975855445},{"lat":46.715753391121,"lon":10.71882051775},{"lat":46.715631615066,"lon":10.71876257405},{"lat":46.715512130635,"lon":10.718705724027},{"lat":46.715305622637,"lon":10.71867381613},{"lat":46.71501910372,"lon":10.718576397313},{"lat":46.714827574128,"lon":10.718446013815},{"lat":46.714542073999,"lon":10.718280753129},{"lat":46.714247799344,"lon":10.718100499122},{"lat":46.714025043852,"lon":10.717951953476},{"lat":46.713819136998,"lon":10.717879996874},{"lat":46.71360413673,"lon":10.717814294253},{"lat":46.713397738839,"lon":10.717775033232},{"lat":46.713165128573,"lon":10.717683424122},{"lat":46.712967725779,"lon":10.717644449434},{"lat":46.712681095326,"lon":10.71755439516},{"lat":46.712266937119,"lon":10.717566603779},{"lat":46.711911787473,"lon":10.717544701606},{"lat":46.711605657182,"lon":10.717554612653},{"lat":46.711408904596,"lon":10.717472322748},{"lat":46.711171882274,"lon":10.717374852944},{"lat":46.710944235385,"lon":10.717252330753},{"lat":46.710541599508,"lon":10.717096459447},{"lat":46.71027344944,"lon":10.716974290556},{"lat":46.710081696856,"lon":10.716858636194},{"lat":46.709808165753,"lon":10.716795176273},{"lat":46.709543789238,"lon":10.716721375772},{"lat":46.709229203309,"lon":10.716695044991},{"lat":46.709188761825,"lon":10.716691307764},{"lat":46.709041407459,"lon":10.716806479725},{"lat":46.708792638943,"lon":10.71700091163},{"lat":46.708588014833,"lon":10.717143238541},{"lat":46.708440889936,"lon":10.717351986513},{"lat":46.708271264483,"lon":10.717560835516},{"lat":46.708004759358,"lon":10.717928507502},{"lat":46.70784787691,"lon":10.718187633601},{"lat":46.707619498976,"lon":10.71841342058},{"lat":46.707222757676,"lon":10.718763866445},{"lat":46.707048754952,"lon":10.718964390892},{"lat":46.706874751888,"lon":10.719164914055},{"lat":46.706735746492,"lon":10.719431959518},{"lat":46.706365250519,"lon":10.719832284827},{"lat":46.705984750295,"lon":10.720299333227},{"lat":46.705865529016,"lon":10.720450131628},{"lat":46.705700356978,"lon":10.720659047677},{"lat":46.705504109003,"lon":10.720842500795},{"lat":46.705329832271,"lon":10.721060991486},{"lat":46.705178719318,"lon":10.721235249392},{"lat":46.704976829207,"lon":10.721494556714},{"lat":46.704776439013,"lon":10.721654163297},{"lat":46.704384173463,"lon":10.722005525993},{"lat":46.703956036948,"lon":10.722348385639},{"lat":46.703582153419,"lon":10.722674162957},{"lat":46.703253761785,"lon":10.722967041291},{"lat":46.703016490422,"lon":10.723185146516},{"lat":46.702852238656,"lon":10.723335261269},{"lat":46.702665215614,"lon":10.723503456402},{"lat":46.70226332139,"lon":10.723896184193},{"lat":46.701902039577,"lon":10.724281204653},{"lat":46.701569146363,"lon":10.72457392426},{"lat":46.701381887504,"lon":10.724757635968},{"lat":46.701158376672,"lon":10.724958177976},{"lat":46.700916727318,"lon":10.725167951186},{"lat":46.700735086665,"lon":10.725277438185},{"lat":46.700512696536,"lon":10.725403615411},{"lat":46.700339952211,"lon":10.725519924772},{"lat":46.70010955279,"lon":10.725580440856},{"lat":46.699641299595,"lon":10.725599036301},{"lat":46.699171776702,"lon":10.725701798894},{"lat":46.69877549695,"lon":10.725721871013},{"lat":46.698325357177,"lon":10.725732870328},{"lat":46.698123089507,"lon":10.725718249075},{"lat":46.697903854636,"lon":10.725635231738},{"lat":46.697636083011,"lon":10.72548854069},{"lat":46.697208062051,"lon":10.725226380519},{"lat":46.69680203545,"lon":10.724997625195},{"lat":46.696382798953,"lon":10.724749648712},{"lat":46.696013158357,"lon":10.724495083793},{"lat":46.695854287721,"lon":10.724288104169},{"lat":46.695379499202,"lon":10.723844628394},{"lat":46.694704360813,"lon":10.723259085208},{"lat":46.694215211949,"lon":10.723469959365},{"lat":46.693780920178,"lon":10.723623715799},{"lat":46.693541809512,"lon":10.723665153203},{"lat":46.693112519833,"lon":10.72378555189},{"lat":46.692701653603,"lon":10.723896762627},{"lat":46.692547748367,"lon":10.723938422745},{"lat":46.692099840063,"lon":10.724099911922},{"lat":46.691783691453,"lon":10.724177314394},{"lat":46.691539073143,"lon":10.724285601254},{"lat":46.691339307424,"lon":10.724403489296},{"lat":46.691179687318,"lon":10.724544723291},{"lat":46.690823899202,"lon":10.724863629048},{"lat":46.69060090578,"lon":10.725029818152},{"lat":46.690298495732,"lon":10.725091302815},{"lat":46.689918222116,"lon":10.725243486953},{"lat":46.68969621398,"lon":10.725344311767},{"lat":46.689454946087,"lon":10.725528714982},{"lat":46.689074289817,"lon":10.725706222145},{"lat":46.688839417157,"lon":10.725764945749},{"lat":46.688481779576,"lon":10.725609693917},{"lat":46.688292141971,"lon":10.72535435609},{"lat":46.688107383303,"lon":10.725073835412},{"lat":46.687889500871,"lon":10.724602633165},{"lat":46.687692762213,"lon":10.724221198638},{"lat":46.687491257324,"lon":10.724155935022},{"lat":46.687161612412,"lon":10.723934565718},{"lat":46.686904855832,"lon":10.723952550137},{"lat":46.686717212847,"lon":10.723863209229},{"lat":46.68654971438,"lon":10.723631476098},{"lat":46.68630595334,"lon":10.723384237646},{"lat":46.686117442573,"lon":10.723053758774},{"lat":46.685792310382,"lon":10.722532582388},{"lat":46.685625301075,"lon":10.722268179715},{"lat":46.685447660315,"lon":10.72211214389},{"lat":46.685201657693,"lon":10.722013599379},{"lat":46.684973018167,"lon":10.721957292656},{"lat":46.685080397723,"lon":10.721699162235},{"lat":46.685354900815,"lon":10.721398936207},{"lat":46.685751662262,"lon":10.720748687518},{"lat":46.685938152198,"lon":10.720316518856},{"lat":46.686135785149,"lon":10.719741665065},{"lat":46.686271275147,"lon":10.719409221635},{"lat":46.686329912106,"lon":10.71910049274},{"lat":46.686437530858,"lon":10.718826011},{"lat":46.686504523261,"lon":10.718560047513},{"lat":46.686518881344,"lon":10.7182033249},{"lat":46.686497380214,"lon":10.717837288361},{"lat":46.68649872161,"lon":10.717448274904},{"lat":46.68653721972,"lon":10.716981974012},{"lat":46.686520175481,"lon":10.716618532706},{"lat":46.686515789425,"lon":10.716311072097},{"lat":46.686480507519,"lon":10.715963400357},{"lat":46.686467761607,"lon":10.71561317339},{"lat":46.686445590629,"lon":10.715291256795},{"lat":46.686518089081,"lon":10.714957622025},{"lat":46.686591186558,"lon":10.714583956977},{"lat":46.686748765415,"lon":10.713977567911},{"lat":46.686811108057,"lon":10.713420473563},{"lat":46.686834714537,"lon":10.713046058391},{"lat":46.686861569827,"lon":10.712755112103},{"lat":46.6869525063,"lon":10.712091028594},{"lat":46.686983844545,"lon":10.711801041814},{"lat":46.68703004373,"lon":10.71111919507},{"lat":46.68712655267,"lon":10.710081753637},{"lat":46.687180613726,"lon":10.709475348373},{"lat":46.687221209165,"lon":10.709167669143},{"lat":46.687253540777,"lon":10.708810687431},{"lat":46.687271024042,"lon":10.708543961931},{"lat":46.687258340831,"lon":10.708188013753},{"lat":46.687203643934,"lon":10.70763212238},{"lat":46.68710328607,"lon":10.70681896007},{"lat":46.687047948816,"lon":10.706305553862},{"lat":46.686957590543,"lon":10.705726476824},{"lat":46.686895181023,"lon":10.705385309815},{"lat":46.686828979044,"lon":10.704996621174},{"lat":46.686743433887,"lon":10.704698048858},{"lat":46.686626514061,"lon":10.704391132672},{"lat":46.686509203901,"lon":10.704110363755},{"lat":46.686282871135,"lon":10.70359649279},{"lat":46.686140908652,"lon":10.703158020064},{"lat":46.686158974568,"lon":10.702851268554},{"lat":46.686174779172,"lon":10.702394055351},{"lat":46.686077764085,"lon":10.701958636623},{"lat":46.6860349876,"lon":10.701809353129},{"lat":46.685962319333,"lon":10.701552061529},{"lat":46.685913958251,"lon":10.700870519614},{"lat":46.685953348174,"lon":10.700339672246},{"lat":46.685968104737,"lon":10.699649484818},{"lat":46.685748724565,"lon":10.698969119947},{"lat":46.685604866398,"lon":10.698354064138},{"lat":46.68552866276,"lon":10.698031282096},{"lat":46.685367669548,"lon":10.697357662634},{"lat":46.685322728485,"lon":10.697050574585},{"lat":46.685241112254,"lon":10.696485698361},{"lat":46.685225088249,"lon":10.696353114024},{"lat":46.685164959765,"lon":10.695855608981},{"lat":46.685229750461,"lon":10.69543099354},{"lat":46.685297105714,"lon":10.694833184253},{"lat":46.685333031029,"lon":10.694534347764},{"lat":46.685504856061,"lon":10.693870331382},{"lat":46.685633489582,"lon":10.693388039821},{"lat":46.685771599973,"lon":10.692873351999},{"lat":46.685995850509,"lon":10.692010713618},{"lat":46.68612035309,"lon":10.691502948455},{"lat":46.686206118515,"lon":10.691180325228},{"lat":46.686435935283,"lon":10.690549153128},{"lat":46.686693506998,"lon":10.689866534512},{"lat":46.686807629415,"lon":10.689451611983},{"lat":46.686978689646,"lon":10.688837394595},{"lat":46.687136265686,"lon":10.688221934185},{"lat":46.687258642242,"lon":10.687857122278},{"lat":46.687240324309,"lon":10.68757374672},{"lat":46.687163608195,"lon":10.687283648331},{"lat":46.687120109933,"lon":10.686876886353},{"lat":46.68701373909,"lon":10.686461628921},{"lat":46.686647958337,"lon":10.685939399034},{"lat":46.686475426334,"lon":10.685738686211},{"lat":46.686257736618,"lon":10.685548828187},{"lat":46.686080561816,"lon":10.685357778513},{"lat":46.685876520887,"lon":10.68515772426},{"lat":46.685485899269,"lon":10.684794122581},{"lat":46.68532185524,"lon":10.684628006253},{"lat":46.685153553813,"lon":10.6844454153},{"lat":46.68480345702,"lon":10.684079814197},{"lat":46.684577755022,"lon":10.683822700068},{"lat":46.684354349796,"lon":10.683715225857},{"lat":46.684185433657,"lon":10.683574303142},{"lat":46.683998646802,"lon":10.683424652985},{"lat":46.683798354626,"lon":10.683275403185},{"lat":46.683580420079,"lon":10.683101903152},{"lat":46.683439366605,"lon":10.682902185605},{"lat":46.683326524528,"lon":10.682619984311},{"lat":46.68311699115,"lon":10.682181127667},{"lat":46.683083556216,"lon":10.682133871879},{"lat":46.682817237945,"lon":10.681757457612},{"lat":46.682542536102,"lon":10.681466150795},{"lat":46.682145963545,"lon":10.681200487556},{"lat":46.681905537142,"lon":10.681026303551},{"lat":46.681563823946,"lon":10.680701870603},{"lat":46.681256495329,"lon":10.680487202744},{"lat":46.681072979695,"lon":10.680114562218},{"lat":46.680894224443,"lon":10.679724088922},{"lat":46.680621807568,"lon":10.679276779787},{"lat":46.680616694886,"lon":10.679269366605},{"lat":46.680472003445,"lon":10.679059651481},{"lat":46.680286301232,"lon":10.678835689812},{"lat":46.680141461394,"lon":10.678586846827},{"lat":46.679918819265,"lon":10.678326763723},{"lat":46.679800819404,"lon":10.678188921529},{"lat":46.679476717047,"lon":10.677890397562},{"lat":46.679143989776,"lon":10.677566277596},{"lat":46.678918044621,"lon":10.677324739612},{"lat":46.678664334281,"lon":10.67713546242},{"lat":46.678318590524,"lon":10.676778260523},{"lat":46.678101746766,"lon":10.676529654641},{"lat":46.677969916018,"lon":10.676313915851},{"lat":46.677865071049,"lon":10.676099015978},{"lat":46.677899010055,"lon":10.675625262939},{"lat":46.677930147861,"lon":10.675035381502},{"lat":46.677983529759,"lon":10.674155255009},{"lat":46.678028655063,"lon":10.673531480755},{"lat":46.678047608875,"lon":10.673158596836},{"lat":46.678121410927,"lon":10.672419661306},{"lat":46.678181962886,"lon":10.671971241412},{"lat":46.678137897713,"lon":10.67129159154},{"lat":46.678051081803,"lon":10.671073987847},{"lat":46.677841025617,"lon":10.670667891728},{"lat":46.67775501959,"lon":10.670394744833},{"lat":46.677715123071,"lon":10.670045383248},{"lat":46.677693574051,"lon":10.669672071179},{"lat":46.67770241902,"lon":10.669065973439},{"lat":46.677793559276,"lon":10.668061975418},{"lat":46.677681245384,"lon":10.667123629757},{"lat":46.677577466989,"lon":10.666525509248},{"lat":46.677506419531,"lon":10.666151493315},{"lat":46.677389249816,"lon":10.665545611794},{"lat":46.67735200492,"lon":10.665322187278},{"lat":46.677352568322,"lon":10.664665171601},{"lat":46.677364879917,"lon":10.663818925017},{"lat":46.677431982393,"lon":10.663536597413},{"lat":46.677530785248,"lon":10.662930808954},{"lat":46.677575278134,"lon":10.662655957797},{"lat":46.677646887357,"lon":10.662372950308},{"lat":46.677670302549,"lon":10.662000202056},{"lat":46.677621929292,"lon":10.661303275058},{"lat":46.677573196079,"lon":10.660630851351},{"lat":46.677377235584,"lon":10.660181105425},{"lat":46.677106293001,"lon":10.659626914553},{"lat":46.676974927428,"lon":10.659376912913},{"lat":46.676727051484,"lon":10.659006802558},{"lat":46.676675430747,"lon":10.658929725942},{"lat":46.676499784857,"lon":10.658630159999},{"lat":46.675973017569,"lon":10.658340282996},{"lat":46.675450261789,"lon":10.658084037137},{"lat":46.675280708744,"lon":10.657984873182},{"lat":46.675044636288,"lon":10.657818304578},{"lat":46.674849055197,"lon":10.657652157157},{"lat":46.674443404902,"lon":10.657388064474},{"lat":46.673947301863,"lon":10.657155530672},{"lat":46.673580355403,"lon":10.657015201705},{"lat":46.673206696391,"lon":10.656716959415},{"lat":46.673019978897,"lon":10.656560082831},{"lat":46.672788271791,"lon":10.656402647974},{"lat":46.672608121026,"lon":10.656102974443},{"lat":46.672507983279,"lon":10.655871117815},{"lat":46.672340946078,"lon":10.655597996325},{"lat":46.672045364123,"lon":10.655190210793},{"lat":46.671989162258,"lon":10.654863256014},{"lat":46.670701748473,"lon":10.653980019031},{"lat":46.669262403059,"lon":10.652017210548},{"lat":46.668057285316,"lon":10.650772322086},{"lat":46.667052882544,"lon":10.649178262702},{"lat":46.665758109715,"lon":10.647362239197},{"lat":46.66476387487,"lon":10.645057979656},{"lat":46.664058925822,"lon":10.643046820126},{"lat":46.663351900848,"lon":10.6411777786},{"lat":46.662291329759,"lon":10.640079762604},{"lat":46.661095229699,"lon":10.638196045334},{"lat":46.658978078421,"lon":10.635716162712},{"lat":46.65531625371,"lon":10.63176893042},{"lat":46.648681851026,"lon":10.623541498424},{"lat":46.645593681384,"lon":10.617055579109},{"lat":46.64161492486,"lon":10.607773658541},{"lat":46.641545791519,"lon":10.607204677673},{"lat":46.63892974705,"lon":10.600762903898},{"lat":46.637776436573,"lon":10.59906752371},{"lat":46.630827319092,"lon":10.575135088652},{"lat":46.632777580942,"lon":10.573789541399},{"lat":46.634270360314,"lon":10.573293526574},{"lat":46.635255117085,"lon":10.571919866415},{"lat":46.635878875216,"lon":10.569780668978},{"lat":46.637410064088,"lon":10.566481104714},{"lat":46.63881229852,"lon":10.56716879606},{"lat":46.640526378588,"lon":10.566786808453},{"lat":46.642013220291,"lon":10.5667218645},{"lat":46.643947149169,"lon":10.566561949829},{"lat":46.64625241799,"lon":10.566412746985},{"lat":46.649598916351,"lon":10.566185706059},{"lat":46.651611539254,"lon":10.565704343687},{"lat":46.654083046185,"lon":10.564265097489},{"lat":46.656419259117,"lon":10.561850687413},{"lat":46.65823407282,"lon":10.559528985478},{"lat":46.659984848123,"lon":10.556449910955},{"lat":46.661160431427,"lon":10.551951289157},{"lat":46.661284397843,"lon":10.548285770488},{"lat":46.660798071668,"lon":10.545789893047},{"lat":46.660742743263,"lon":10.544385450473},{"lat":46.662014048604,"lon":10.543774169233},{"lat":46.66455228683,"lon":10.542875157756},{"lat":46.666127930608,"lon":10.541732841891},{"lat":46.667110866904,"lon":10.540465689137},{"lat":46.669215079063,"lon":10.538690683283},{"lat":46.675668860426,"lon":10.533908553368},{"lat":46.680768288353,"lon":10.530382514303},{"lat":46.684672103876,"lon":10.527361932802},{"lat":46.687984565385,"lon":10.524108348305},{"lat":46.69016136542,"lon":10.52244205371},{"lat":46.692262435664,"lon":10.520881477401},{"lat":46.693997874813,"lon":10.51887860951},{"lat":46.696581526008,"lon":10.520138892519},{"lat":46.699372171834,"lon":10.52259299662},{"lat":46.701057357865,"lon":10.524368267991},{"lat":46.702185890959,"lon":10.54253993678},{"lat":46.702278017161,"lon":10.543203724563},{"lat":46.702368124679,"lon":10.5432197588},{"lat":46.703407191261,"lon":10.547029408373},{"lat":46.703795119106,"lon":10.54935730352},{"lat":46.70521680959,"lon":10.55586084571},{"lat":46.706978528691,"lon":10.562008711769},{"lat":46.708503388772,"lon":10.567052584588},{"lat":46.708941286336,"lon":10.571821279521},{"lat":46.708359312656,"lon":10.57753593067},{"lat":46.707634637712,"lon":10.581417093722},{"lat":46.706176433005,"lon":10.589788564171},{"lat":46.706615083766,"lon":10.594435317829},{"lat":46.710169679248,"lon":10.598198577431},{"lat":46.713154246079,"lon":10.600725879129},{"lat":46.715130828142,"lon":10.603345566552},{"lat":46.719017090244,"lon":10.607363815093},{"lat":46.721814855807,"lon":10.611228252411},{"lat":46.724013478399,"lon":10.615929092487},{"lat":46.727059040097,"lon":10.620045738001},{"lat":46.729775970214,"lon":10.623664999137},{"lat":46.730923899063,"lon":10.625529441147},{"lat":46.732648334536,"lon":10.628143324521},{"lat":46.733548116192,"lon":10.628665209028},{"lat":46.733560268336,"lon":10.628902807326},{"lat":46.735111707334,"lon":10.631877735137},{"lat":46.736664806866,"lon":10.634730874121},{"lat":46.738637082463,"lon":10.637596874836},{"lat":46.739330547498,"lon":10.641888501897},{"lat":46.740972498102,"lon":10.644378793413},{"lat":46.743470435472,"lon":10.645675037964},{"lat":46.745645248897,"lon":10.646107335118},{"lat":46.748197132319,"lon":10.649480068615},{"lat":46.751009267067,"lon":10.652250859953},{"lat":46.753234391256,"lon":10.655003966396},{"lat":46.75375240639,"lon":10.659779804249},{"lat":46.754889088741,"lon":10.662377828576},{"lat":46.756432519165,"lon":10.665842892384},{"lat":46.758061469111,"lon":10.669188738689},{"lat":46.761454687167,"lon":10.672345260338},{"lat":46.764451790981,"lon":10.673902930296},{"lat":46.768399766424,"lon":10.673536930097},{"lat":46.769598610203,"lon":10.671864860578},{"lat":46.771869627747,"lon":10.671446790628},{"lat":46.776563308508,"lon":10.671714159157},{"lat":46.782348783551,"lon":10.67189328098},{"lat":46.784182723347,"lon":10.672682788475},{"lat":46.7868426262,"lon":10.674352835088},{"lat":46.788341155952,"lon":10.675132090108},{"lat":46.789154594478,"lon":10.676867162203},{"lat":46.790048271429,"lon":10.678849050521},{"lat":46.791778587521,"lon":10.680979192551},{"lat":46.793346554188,"lon":10.682737992042},{"lat":46.793783485819,"lon":10.683182085805},{"lat":46.793657872201,"lon":10.683326161194},{"lat":46.793572220248,"lon":10.683632935214},{"lat":46.793553372706,"lon":10.683700442868},{"lat":46.79331886663,"lon":10.684347478435},{"lat":46.793251947552,"lon":10.684614008829},{"lat":46.793140270058,"lon":10.685169869836},{"lat":46.793040116829,"lon":10.685859580029},{"lat":46.792984865501,"lon":10.686250135627},{"lat":46.792971657543,"lon":10.686434065556},{"lat":46.792939569969,"lon":10.686880953805},{"lat":46.792940012371,"lon":10.687156136557},{"lat":46.79293221252,"lon":10.687478041969},{"lat":46.792928513193,"lon":10.687630770977},{"lat":46.792885088797,"lon":10.687829238009},{"lat":46.792835922612,"lon":10.688111875764},{"lat":46.792665240112,"lon":10.688701095695},{"lat":46.792508917501,"lon":10.689231797071},{"lat":46.792420866541,"lon":10.690014413349},{"lat":46.792335664781,"lon":10.690603841883},{"lat":46.792347389356,"lon":10.691028423284},{"lat":46.792414813651,"lon":10.691337642584},{"lat":46.792459894462,"lon":10.691636331786},{"lat":46.792514199601,"lon":10.691919752227},{"lat":46.792613358775,"lon":10.692212769057},{"lat":46.792919568276,"lon":10.692805465739},{"lat":46.793063107361,"lon":10.693140009134},{"lat":46.793177391551,"lon":10.693322944748},{"lat":46.79349126752,"lon":10.693701326173},{"lat":46.793803954405,"lon":10.69415993364},{"lat":46.793976450778,"lon":10.694361901496},{"lat":46.794317344906,"lon":10.694738687809},{"lat":46.794645351397,"lon":10.695074121898},{"lat":46.794950602081,"lon":10.695426866137},{"lat":46.795145001632,"lon":10.695668842097},{"lat":46.795295682799,"lon":10.696128115015},{"lat":46.795449335683,"lon":10.696386832139},{"lat":46.795540847404,"lon":10.696587905462},{"lat":46.795543797103,"lon":10.696995857665},{"lat":46.795617321968,"lon":10.697499395253},{"lat":46.795633769807,"lon":10.697603926744},{"lat":46.795696984732,"lon":10.698195593309},{"lat":46.795929644668,"lon":10.698587844986},{"lat":46.796140411016,"lon":10.698939278016},{"lat":46.796329430006,"lon":10.699240071203},{"lat":46.796492946197,"lon":10.699440144202},{"lat":46.796629561754,"lon":10.699633639703},{"lat":46.79683366473,"lon":10.699827620758},{"lat":46.797017703722,"lon":10.699952928801},{"lat":46.797043031132,"lon":10.699970172597},{"lat":46.797203130946,"lon":10.700097251688},{"lat":46.797370202397,"lon":10.700663544198},{"lat":46.797485259846,"lon":10.701096339109},{"lat":46.797529870545,"lon":10.701476350184},{"lat":46.79753717943,"lon":10.701538611406},{"lat":46.797552982891,"lon":10.701988756347},{"lat":46.797576655851,"lon":10.702212278044},{"lat":46.797652837335,"lon":10.702535739749},{"lat":46.797838398512,"lon":10.703068228913},{"lat":46.797911676423,"lon":10.703284310292},{"lat":46.798084058481,"lon":10.703492871801},{"lat":46.79827931794,"lon":10.703675947784},{"lat":46.798527596784,"lon":10.70392458439},{"lat":46.798870382493,"lon":10.704474340638},{"lat":46.799170056398,"lon":10.704897425416},{"lat":46.799729829697,"lon":10.705379519992},{"lat":46.800055209628,"lon":10.705587196538},{"lat":46.800101613425,"lon":10.707001551002},{"lat":46.800131414563,"lon":10.707718356476},{"lat":46.800149442137,"lon":10.708017884214},{"lat":46.8002203871,"lon":10.708690946808},{"lat":46.800261444156,"lon":10.709557181604},{"lat":46.800266122616,"lon":10.709637121674},{"lat":46.800292495213,"lon":10.710087746855},{"lat":46.800300872864,"lon":10.71023088366},{"lat":46.800299106011,"lon":10.710244690215},{"lat":46.800249925444,"lon":10.710628973413},{"lat":46.80016323331,"lon":10.711310963714},{"lat":46.800161981859,"lon":10.711328421949},{"lat":46.800143832393,"lon":10.711581462968},{"lat":46.800140492006,"lon":10.711628039721},{"lat":46.800086036219,"lon":10.712260268066},{"lat":46.800030424931,"lon":10.712668855739},{"lat":46.800016589164,"lon":10.712991944971},{"lat":46.799997009832,"lon":10.713042090099},{"lat":46.799941723849,"lon":10.713183687573},{"lat":46.799794380994,"lon":10.713708122126},{"lat":46.799697918989,"lon":10.714139976962},{"lat":46.799602947181,"lon":10.71477254819},{"lat":46.799490699915,"lon":10.715056471084},{"lat":46.799498478624,"lon":10.715738172473},{"lat":46.799492487372,"lon":10.716137680997},{"lat":46.799487258417,"lon":10.716786206509},{"lat":46.799545875724,"lon":10.717377791994},{"lat":46.799613510422,"lon":10.717668252802},{"lat":46.799788001205,"lon":10.718333969698},{"lat":46.799834990273,"lon":10.718500916344},{"lat":46.800067119668,"lon":10.719223350847},{"lat":46.800205602492,"lon":10.719589790561}]

		const catchment = L.polygon(points, {color: '#3388ff', fillColor: '#000000', fillOpacity: 0.2}).addTo(map);

		// Add map layers.
		L.control.layers(basemap, {}, {'collapsed': false}).addTo(map)

		Object.keys(opts.data).map(function(k) {
			let item = opts.data[k];

			let marker = L.marker([item.Latitude, item.Longitude]).addTo(map);
			let c = document.getElementById("s"+item.ID)

			marker.bindPopup(c, {
			autoPan: true,
			keepInView: true,
			maxWidth: 600});

			marker.bindTooltip(c.getAttribute("data-name"))

			mapMarkers[item.ID] = marker
		});

		map.fitBounds(catchment.getBounds());

		L.Control.DownloadArea = L.Control.extend({
			onAdd: function(map) {
				const div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control-layers-expanded');
				div.appendChild(document.getElementById(opts.dlMapAreaEl));
				return div;
			},

			onRemove: function(map) {},
		});

		L.control.downloadArea = function(opts) {
			return new L.Control.DownloadArea(opts);
		}

		L.control.downloadArea({position: 'topright'}).addTo(map);
		L.control.scale({position: "bottomright"}).addTo(map);
		L.control.zoom({position: "bottomright"}).addTo(map);
	}

	// isValidDateRange checks if the selected date range is valid and
	// returns true for a valid range otherwise false.
	function isValidDateRange() {
		var startDate = new Date($(opts.sDateEl).val());
		startDate.setHours(0,0,0,0);

		var endDate = new Date($(opts.eDateEl).val());
		endDate.setFullYear(endDate.getFullYear() - 1);
		endDate.setHours(0,0,0,0);

		if (startDate < endDate) {
			return false;
		}

		return true;
	}

	// toggleDownload enables the download botton if at least one
	// station and one measurement was selected. Moreover it checks
	// if the time range selected is not ore than a year. Otherwise
	// it will be disable it.
	function toggleDownload() {
		if ($(opts.sDateEl).val() == "" || $(opts.eDateEl).val() == "") {
			$(opts.submitEl).attr("disabled", "disabled");
			return
		}

		if (! isValidDateRange()) {
			$(opts.submitEl).attr("disabled", "disabled");
			return
		}

		if ($(opts.stationEl).val() == null) {
			$(opts.submitEl).attr("disabled", "disabled");
			$(opts.codeEl).attr("disabled", "disabled");
			return
		}

		if ($(opts.measurementEl).val() == null) {
			$(opts.submitEl).attr("disabled", "disabled");
			$(opts.codeEl).attr("disabled", "disabled");
			return
		}

		$(opts.submitEl).removeAttr("disabled");
		$(opts.codeEl).removeAttr("disabled");
	}

	// ToggleOptions enables or disables an option.
	// arr is an array of objects with these keys:
	// 	[{ el: "id of select", data: "set of items"}]
	function toggleOptions(arr) {
		arr.forEach(function(item) {
			$(item.el).children('option').map(function() {
				if (item.data.size === 0) {
					$(this).prop('disabled', false);
					return
				}
				if (item.data.has(this.value)) {
					$(this).prop('disabled', false);
					return
				}

				$(this).prop('disabled', true);
				$(this).prop('selected', false);
			});

			$(item.el).multiselect('refresh')
		});
	}

	// filterByMeasurements filters the global opts.data object by the
	// given measurements and returns an object with the following keys:
	// 	stations - set of stations
	//	landuse - set of landuses
	function filterByMeasurements(names) {
		const stations = new Set();
		const landuse = new Set();

		if (! Array.isArray(names)) {
				return {stations, landuse}
		}

		opts.data.forEach(function(o) {
			if (! Array.isArray(o.Measurements)) {
				return {stations, landuse}
			}

			let result = names.every(function(val) {
				return o.Measurements.indexOf(val) >= 0
			});
			if (result) {
				stations.add(o.ID);
				landuse.add(o.Landuse);
			}
		});

		return {stations, landuse};
	}

	// filterByStations filters the global opts.data object by the given
	// stations and returns an object with the following keys:
	// 	measurements - set of measurements
	//	landuse - set of landuses
	function filterByStations(stations) {
		let measurements = new Set();
		const landuse = new Set();

		if (! Array.isArray(stations)) {
			return {measurements, landuse};
		}

		opts.data.forEach(function(o, i) {
			if (stations.indexOf(o.ID) < 0) {
				return;
			}

			if (Array.isArray(o.Measurements)) {
				if (measurements.size === 0) {
					o.Measurements.forEach(m => measurements.add(m));
					return;
				}
				measurements = new Set(o.Measurements.filter(x => measurements.has(x)));
			}
			landuse.add(o.Landuse);
		});

		return {measurements, landuse};
	}

	// filterByLanduse filters the global opts.data object by the given
	// landuses and returns an object with the following keys:
	// 	measurements - set of measurements
	//	stations - set of stations
	function filterByLanduse(landuse) {
		const measurements = new Set();
		const stations = new Set();

		if (! Array.isArray(landuse)) {
			return {measurements, stations};
		}

		opts.data.forEach(function(o) {
			if (landuse.indexOf(o.Landuse) < 0) {
				return;
			}

			if (Array.isArray(o.Measurements)) {
				o.Measurements.forEach(m => measurements.add(m));
			}
			stations.add(o.ID);
		});

		return {measurements, stations};
	}

	function toggleMapMarkers() {
		const blue = L.icon({
    			iconUrl: '/static/third_party/leaflet/images/marker-icon.png',
    			iconRetinaUrl: '/static/third_party/leaflet/images/marker-icon-2x.png',
    			iconSize: [25, 41],
   			iconAnchor: [12, 41],
    			popupAnchor: [1, -34],
    			tooltipAnchor: [16, -28],
    			shadowUrl: '/static/third_party/leaflet/images/marker-shadow.png',
    			shadowSize: [41, 41],
		});

		const yellow = L.icon({
    			iconUrl: '/static/third_party/leaflet/images/marker-icon-yellow.png',
    			iconRetinaUrl: '/static/third_party/leaflet/images/marker-icon-2x-yellow.png',
    			iconSize: [25, 41],
   			iconAnchor: [12, 41],
    			popupAnchor: [1, -34],
    			tooltipAnchor: [16, -28],
    			shadowUrl: '/static/third_party/leaflet/images/marker-shadow.png',
    			shadowSize: [41, 41],
		});

		$(opts.stationEl).children('option').map(function() {
			let el = $(this)
			let m = mapMarkers[el.val()];

			if (el.prop('selected')) {
				m.setIcon(yellow);
			} else {
				m.setIcon(blue);
			}
		});
	}

	function handleUpdateMeasurement() {
		const m = filterByMeasurements($(opts.measurementEl).val());

		toggleOptions([
			{el: opts.stationEl, data: m.stations},
			{el: opts.landuseEl, data: m.landuse}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	function handleUpdateStation() {
		const s = filterByStations($(opts.stationEl).val());

		toggleOptions([
			{el: opts.measurementEl, data: s.measurements},
			{el: opts.landuseEl, data: s.landuse}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	function handleUpdateLanduse() {
		const l = filterByLanduse($(opts.landuseEl).val());

		toggleOptions([
			{el: opts.measurementEl, data: l.measurements},
			{el: opts.stationEl, data: l.stations}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	let stdOptions = [];

	function hideStdOptions() {
		stdOptions = [];
		$(opts.measurementEl).children('option').map(function() {
			let el = $(this);
			let v = el.val();

			if (v.endsWith("_std")) {
				stdOptions.push(el.remove());
			}
		});
	}

	// Hide all standard deviations.
	hideStdOptions();

	// Initialize UI elements
	$(opts.measurementEl).multiselect({
		maxHeight: 400,
		buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateMeasurement();
		},
		onSelectAll: function() {
			handleUpdateMeasurement();
		},
		onDeselectAll: function() {
			handleUpdateMeasurement();
		},
	});

	$('#showStd').on('change', function() {
		if (this.checked) {
			stdOptions.forEach(function(o) {
				$(opts.measurementEl).append(o);
			});

			const options = $("#measurements option");
			options.detach().sort(function(a,b) {
   				let at = $(a).text();
    				let bt = $(b).text();
    				return (at > bt)?1:((at < bt)?-1:0);
			});
			options.appendTo(opts.measurementEl);
		} else {
			hideStdOptions();
		}
		$(opts.measurementEl).multiselect("rebuild");
		handleUpdateStation();
	});

	$(opts.stationEl).multiselect({
		maxHeight: 400,
	 	buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableFullValueFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateStation();
		},
		onSelectAll: function() {
			handleUpdateStation();
		},
		onDeselectAll: function() {
			handleUpdateStation();
		},
	});

	$(opts.landuseEl).multiselect({
		maxHeight: 400,
		buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableFullValueFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateLanduse();
		},
		onSelectAll: function() {
			handleUpdateLanduse();
		},
		onDeselectAll: function() {
			handleUpdateLanduse();
		},
	});

	$(opts.altitudeEl).ionRangeSlider({
		skin: "round",
		type: "double",
		min: getMinAltitude(),
		max: getMaxAltitude(),
		grid: true,
		onChange: function(data) {
			const stations = new Set();
			const landuse = new Set();
			const measurements = new Set();

			opts.data.forEach(function(item) {
				let marker = mapMarkers[item.ID]
				if (item.Altitude >= data.from && item.Altitude <= data.to) {
					stations.add(item.ID);
					landuse.add(item.Landuse);
					if (Array.isArray(item.Measurements)) {
						item.Measurements.forEach(m => measurements.add(m));
					}

					marker.setOpacity(1.0);
				} else {
					marker.setOpacity(0.4);
				}
			});

			toggleOptions([
				{el: opts.measurementEl, data: measurements},
				{el: opts.stationEl, data: stations},
				{el: opts.landuse, data: landuse},
			]);
		}
	 });


	$(opts.dateEl).datepicker({
		todayHighlight: true,
		format: 'yyyy-mm-dd',
		endDate: new Date()
	}).on('hide', function() {
		toggleDownload();

		if ($(opts.sDateEl).val() == "" || $(opts.eDateEl).val() == "") {
			$(opts.dateEl).popover('show')
			return
		}

		if (isValidDateRange()) {
			$(opts.sDateEl).popover('hide');

			return
		}

		$(opts.sDateEl).popover('show');
	}).on('show', function() {
		$(opts.dateEl).popover('hide');
	});

	loadMap();
}
